<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”—</text></svg>">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="animated-background"></div>
    <div class="container py-5 fade-in">
    <h1 class="text-center mb-4 site-title">URL Shortener</h1>
        
        <!-- URL Shortening Form -->
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="glass-card">
                    <div class="card-body">
                        <form id="urlForm" class="mb-3">
                            <div class="url-input-group">
                                <div class="input-group">
                                    <input type="url" class="form-control" id="urlInput" 
                                           placeholder="Enter your URL (including http:// or https://)" required>
                                    <div class="validation-icon">
                                        <i class="fas fa-check text-success d-none" id="urlValid"></i>
                                        <i class="fas fa-times text-danger d-none" id="urlInvalid"></i>
                                    </div>
                                    <button class="btn btn-primary hover-effect" type="submit" id="shortenButton" disabled>
                                        <span class="button-content">
                                            <span class="button-text">Shorten URL</span>
                                            <div class="spinner-border spinner-border-sm d-none" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Result Display -->
                        <div id="resultContainer" class="d-none slide-in">
                            <div class="alert alert-success glass-alert">
                                <p class="mb-2">Your shortened URL:</p>
                                <div class="input-group mb-2">
                                    <input type="text" id="shortUrl" class="form-control" readonly>
                                    <button class="btn btn-outline-light hover-effect" type="button" id="copyButton">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                                <div class="social-share-buttons d-flex justify-content-center flex-wrap gap-2 py-2">
                                    <button type="button" class="btn btn-sm btn-social btn-twitter hover-effect share-btn" data-platform="twitter">
                                        <i class="fab fa-twitter"></i>
                                        <span class="btn-text d-none d-sm-inline ms-2">Tweet</span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-social btn-facebook hover-effect share-btn" data-platform="facebook">
                                        <i class="fab fa-facebook-f"></i>
                                        <span class="btn-text d-none d-sm-inline ms-2">Share</span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-social btn-linkedin hover-effect share-btn" data-platform="linkedin">
                                        <i class="fab fa-linkedin-in"></i>
                                        <span class="btn-text d-none d-sm-inline ms-2">Post</span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-social btn-whatsapp hover-effect share-btn" data-platform="whatsapp">
                                        <i class="fab fa-whatsapp"></i>
                                        <span class="btn-text d-none d-sm-inline ms-2">WhatsApp</span>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-social btn-instagram hover-effect share-btn" data-platform="instagram">
                                        <i class="fab fa-instagram"></i>
                                        <span class="btn-text d-none d-sm-inline ms-2">Instagram</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error Display -->
                        <div id="errorContainer" class="d-none slide-in">
                            <div class="alert alert-danger glass-alert" role="alert">
                                <span id="errorMessage"></span>
                            </div>
                        </div>

                        <!-- Recent URLs Section -->
                        <div id="recentUrls" class="mt-4 d-none slide-in">
                            <h5 class="text-white-50 mb-3">Recent URLs</h5>
                            <div class="recent-urls-list">
                                <!-- Recent URLs will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Table -->
        {% if urls %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="glass-card">
                    <div class="card-body">
                        <h2 class="text-white mb-3">URL Statistics</h2>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Original URL</th>
                                        <th>Short URL</th>
                                        <th>Created At</th>
                                        <th>Clicks</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for url in urls %}
                                    <tr>
                                        <td class="text-truncate" style="max-width: 300px;">
                                            <a href="{{ url['original_url'] }}" class="text-decoration-none" target="_blank">
                                                {{ url['original_url'] }}
                                            </a>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('redirect_to_url', short_code=url['short_code'], _external=True) }}" class="text-decoration-none" target="_blank">
                                                {{ url_for('redirect_to_url', short_code=url['short_code'], _external=True) }}
                                            </a>
                                        </td>
                                        <td>{{ url['created_at'] }}</td>
                                        <td>
                                            <span class="badge bg-primary">{{ url['click_count'] }}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-light hover-effect copy-btn" data-short="{{ url_for('redirect_to_url', short_code=url['short_code'], _external=True) }}">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                <i class="fas fa-check-circle text-success me-2"></i>
                <span id="toastMessage"></span>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Toast initialization
        const toast = new bootstrap.Toast(document.getElementById('toast'));
        
        // URL validation
        const urlInput = document.getElementById('urlInput');
        const urlValid = document.getElementById('urlValid');
        const urlInvalid = document.getElementById('urlInvalid');
        const shortenButton = document.getElementById('shortenButton');

        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        urlInput.addEventListener('input', () => {
            const isValid = isValidUrl(urlInput.value);
            urlValid.classList.toggle('d-none', !isValid);
            urlInvalid.classList.toggle('d-none', isValid);
            shortenButton.disabled = !isValid;
        });

        // Recent URLs management
        const recentUrlsContainer = document.getElementById('recentUrls');
        const recentUrlsList = document.querySelector('.recent-urls-list');

        function loadRecentUrls() {
            const recentUrls = JSON.parse(localStorage.getItem('recentUrls') || '[]');
            if (recentUrls.length > 0) {
                recentUrlsContainer.classList.remove('d-none');
                updateRecentUrlsList(recentUrls);
            }
        }

        function updateRecentUrlsList(urls) {
            // Render recent URLs (last 5)
            recentUrlsList.innerHTML = urls.map((url, i) => `
                <div class="recent-url-item glass-alert mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-truncate me-3">
                            <small class="text-muted d-block">Original: ${url.original}</small>
                            <a href="${url.short}" class="text-decoration-none" target="_blank">${url.short}</a>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-light hover-effect copy-btn" data-short="${url.short}">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger ms-2 delete-btn" data-index="${i}" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function deleteRecentUrl(index) {
            const recent = JSON.parse(localStorage.getItem('recentUrls') || '[]');
            if (!Array.isArray(recent) || index < 0 || index >= recent.length) return;
            // Optional confirmation
            if (!confirm('Remove this recent URL from your list?')) return;
            recent.splice(index, 1);
            localStorage.setItem('recentUrls', JSON.stringify(recent));
            if (recent.length === 0) {
                recentUrlsContainer.classList.add('d-none');
            }
            updateRecentUrlsList(recent);
        }

        function addRecentUrl(originalUrl, shortUrl) {
            const recentUrls = JSON.parse(localStorage.getItem('recentUrls') || '[]');
            recentUrls.unshift({ original: originalUrl, short: shortUrl });
            if (recentUrls.length > 5) recentUrls.pop();
            localStorage.setItem('recentUrls', JSON.stringify(recentUrls));
            recentUrlsContainer.classList.remove('d-none');
            updateRecentUrlsList(recentUrls);
        }

        // Form submission
        document.getElementById('urlForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const resultContainer = document.getElementById('resultContainer');
            const errorContainer = document.getElementById('errorContainer');
            const shortUrlInput = document.getElementById('shortUrl');
            const spinner = document.querySelector('.spinner-border');
            const buttonText = document.querySelector('.button-text');
            
            // Show loading state
            spinner.classList.remove('d-none');
            buttonText.classList.add('d-none');
            shortenButton.disabled = true;
            
            try {
                const response = await fetch('/shorten', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `url=${encodeURIComponent(urlInput.value)}`
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    shortUrlInput.value = data.short_url;
                    resultContainer.classList.remove('d-none');
                    errorContainer.classList.add('d-none');
                    addRecentUrl(urlInput.value, data.short_url);
                    
                    // Auto-copy to clipboard
                    copyToClipboard(data.short_url);
                } else {
                    throw new Error(data.error || 'An error occurred');
                }
            } catch (error) {
                errorContainer.classList.remove('d-none');
                resultContainer.classList.add('d-none');
                document.getElementById('errorMessage').textContent = error.message;
            } finally {
                // Reset loading state
                spinner.classList.add('d-none');
                buttonText.classList.remove('d-none');
                shortenButton.disabled = false;
            }
        });

        function copyToClipboard(text, evt) {
            const textToCopy = text || document.getElementById('shortUrl').value;
            
            const doPulse = (button) => {
                if (!button) return;
                button.classList.add('pulse');
                setTimeout(() => button.classList.remove('pulse'), 900);
            };

            // FIX: Check if clipboard API is available and context is secure
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('URL copied to clipboard!');
                    const btn = evt ? evt.target.closest('button') : document.getElementById('copyButton');
                    doPulse(btn);
                }).catch(() => {
                    // Fallback if clipboard API fails
                    fallbackCopy(textToCopy, evt, doPulse);
                });
            } else {
                // Use fallback for non-secure contexts or older browsers
                fallbackCopy(textToCopy, evt, doPulse);
            }
        }

        // FIX: Add this fallback function
        function fallbackCopy(text, evt, doPulse) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('URL copied to clipboard!');
            } catch (err) {
                showToast('Failed to copy URL');
            }
            document.body.removeChild(textArea);
            const btn = evt ? evt.target.closest('button') : document.getElementById('copyButton');
            doPulse(btn);
        }

        function showToast(message) {
            document.getElementById('toastMessage').textContent = message;
            toast.show();
        }

        function shareUrl(platform) {
            const shortUrl = document.getElementById('shortUrl').value;
            const originalUrl = document.getElementById('urlInput').value;
            let shareLink = '';

            // Create platform-specific sharing messages
            const twitterText = `I just shortened ${originalUrl} to this convenient link:`;
            const linkedinTitle = 'Shortened URL via URL Shortener';
            const linkedinText = `I wanted to share this shortened link with you. Original URL: ${originalUrl}`;

            switch (platform) {
                case 'twitter':
                    shareLink = `https://twitter.com/intent/tweet?text=${encodeURIComponent(twitterText)}&url=${encodeURIComponent(shortUrl)}&hashtags=URLshortener`;
                    break;
                case 'facebook':
                    shareLink = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shortUrl)}&quote=${encodeURIComponent('Check out this shortened URL!')}`;
                    break;
                case 'linkedin':
                    shareLink = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(shortUrl)}&title=${encodeURIComponent(linkedinTitle)}&summary=${encodeURIComponent(linkedinText)}`;
                    break;
                case 'whatsapp':
                    const waText = `Check this out: ${originalUrl}`;
                    shareLink = `https://api.whatsapp.com/send?text=${encodeURIComponent(waText + ' ' + shortUrl)}`;
                    break;
                case 'instagram':
                    // Instagram doesn't provide a direct share URL for links; copy to clipboard and prompt the user
                    copyToClipboard(shortUrl, null);
                    showToast('Short URL copied â€” open Instagram and paste it in a post or story.');
                    return;
                default:
                    return;
            }

            // Open popup only if shareLink was created
            if (shareLink) {
                const width = 600;
                const height = 400;
                const left = (window.innerWidth - width) / 2 + (window.screenX || 0);
                const top = (window.innerHeight - height) / 2 + (window.screenY || 0);
                window.open(
                    shareLink,
                    `share_${platform}`,
                    `width=${width},height=${height},left=${left},top=${top},toolbar=0,location=0,menubar=0,status=0`
                );
                showToast(`Sharing on ${platform.charAt(0).toUpperCase() + platform.slice(1)}...`);
            }
        }

        // Delegated click handling for copy, share, and delete buttons
        document.addEventListener('click', function(e) {
            const deleteBtn = e.target.closest && e.target.closest('.delete-btn');
            if (deleteBtn) {
                const idx = deleteBtn.dataset && deleteBtn.dataset.index;
                if (typeof idx !== 'undefined') deleteRecentUrl(parseInt(idx, 10));
                return;
            }

            const copyBtn = e.target.closest && e.target.closest('.copy-btn');
            if (copyBtn) {
                const short = copyBtn.dataset && copyBtn.dataset.short;
                if (short) copyToClipboard(short, e);
                return;
            }

            const shareBtn = e.target.closest && e.target.closest('.share-btn');
            if (shareBtn) {
                const platform = shareBtn.dataset && shareBtn.dataset.platform;
                if (platform) shareUrl(platform);
                return;
            }
        });

        // Main copy button handler
        const mainCopyBtn = document.getElementById('copyButton');
        if (mainCopyBtn) {
            mainCopyBtn.addEventListener('click', (e) => copyToClipboard(null, e));
        }

        // Initialize
        loadRecentUrls();
    </script>
</body>
</html>